#!/bin/bash

set -e

# restore maven dependencies downloaded in a previous build,
# so they do not have to be downloaded again.
# /opt/s2i/destination/artifacts will only be present in the incremental build scenario
# in which the target image name is an existing docker image which contains
# dependencies from a prior build execution.
function restore_saved_artifacts() {
  if [ "$(ls -A /tmp/artifacts/ 2>/dev/null)" ]; then
    echo "---> Restoring saved artifacts from prior build..."
    mkdir -p $HOME/.m2
    mv /tmp/artifacts/.m2/repository $HOME/.m2
  else
    echo "---> No artifacts found to restore"
  fi
}

echo "---> Installing application source"
cp -Rf /tmp/src/. ./

# restore any maven dependencies which will be present if this is an
# incremental build
echo "---> Restoring saved artifacts..."
restore_saved_artifacts

echo "---> Building Spring Boot application from source"
echo "---> # MVN_ARGS = $MVN_ARGS"

mvn --version
mvn package

# Fix source directory permissions
fix-permissions ./
